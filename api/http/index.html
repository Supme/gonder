<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="assets/w3ui/w2ui-1.4.3.min.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="assets/w3ui/w2ui-1.4.3.js"></script>
    <script src="assets/ckeditor/ckeditor.js"></script>
</head>
<body>

    <div id="layout" style="position: absolute; width: 99%; height: 99%;"></div>

    <div id="bottom" style="visibility: hidden">
        <div id="group" style="position: absolute; left: 0px; width: 39.9%; height: 99%;"></div>
        <div id="campaign" style="position: absolute; right: 0px; width: 59.9%; height: 99%;"></div>
    </div>

    <div id="formbox" style="visibility: hidden">
        <div id="parameter"></div>
        <div id="template">
            <textarea id="campaignTemplate" name="campaignTemplate"></textarea>
        </div>
        <div id="recipient" style="width: 100%;">
            <div id="campaignRecipient" style="height: 400px;"></div>
        </div>
    </div>


    <script type="text/javascript">
        function getDate(dateStr, timeStr) {
            //ToDo parse config format
            //w2utils.settings.dateFormat
            var dateParts = dateStr.split("/");
            var timeParts = timeStr.split(":");
            return new Date(dateParts[2],(dateParts[1] - 1),dateParts[0],timeParts[0],timeParts[1],0);
        }

        function getProfiles(){

            return profile;
        }

    $(function () {

        w2utils.locale('/assets/w3ui/locale/ru-ru.json');

        // --- Config for layout ---
        var config = {
            sidebar: {
                name: 'sidebar',
                topHTML    : '<div style="padding: 10px 5px; border-bottom: 1px solid #99bbe8">MENU</div>',
                nodes: [
                    {
                        id: 'campaign', text: w2utils.lang('Campaign'), group: true, expanded: true, nodes: [
                            {id: 'parameter', text: w2utils.lang('Parameter'), img: 'icon-page', selected: true},
                            {id: 'editor', text: w2utils.lang('Editor'), img: 'w2ui-icon-pencil'},
                            {id: 'recipient', text: w2utils.lang('Recipients'), img: 'w2ui-icon-columns'},
                            {id: 'save', text: w2utils.lang('Save'), img: 'w2ui-icon-check'}
                    ]
                    },
                    {
                        id: 'settings', text: 'Settings', group: true, expanded: false, nodes: [
                            {id: 'profile', text: 'Profiles', img: 'icon-page', selected: true},
                            {id: 'status', text: 'Status', img: 'w2ui-icon-columns'}
                    ]
                    }
                ],
                onClick: function (event) {
                    switch (event.target) {
                        case 'parameter':
                            $('#template').hide();
                            $('#recipient').hide();
                            $('#parameter').show();
                            break;
                        case 'editor':
                            $('#parameter').hide();
                            $('#recipient').hide();
                            $('#template').show();
                            break;
                        case 'recipient':
                            $('#template').hide();
                            $('#parameter').hide();
                            $('#recipient').show();
                            break;
                        case 'save':
                            // --- Get campaign data ---
                            w2ui.layout.lock('main', w2utils.lang('Saving...'), true);
                            data = {
                                "recid": $('#campaignId').val(),
                                "profileId": $('#campaignProfileId').data('selected').id,
                                "name": $('#campaignName').val(),
                                "subject": $("#campaignSubject").val(),
                                "fromEmail": $("#campaignFromEmail").val(),
                                "fromName": $("#campaignFromName").val(),
                                "startDate": getDate($("#campaignStartDate").val(), $("#campaignStartTime").val()).getTime()/1000,
                                "endDate": getDate($("#campaignEndDate").val(), $("#campaignEndTime").val()).getTime()/1000,
                                "sendUnsubscribe": $("#campaignSendUnsubscribe").is(":checked")?"y":"n",
                                "template": CKEDITOR.instances.campaignTemplate.getData() == ''?$("#campaignTemplate").val():CKEDITOR.instances.campaignTemplate.getData(),
                            };
                            $.ajax({
                                type: "POST",
                                dataType: 'json',
                                url: 'api/campaign?cmd=save-data',
                                data: JSON.stringify(data),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                            }).done(function(data) {

                            }).complete(function() {
                                w2ui.layout.lock('main', w2utils.lang('Ok'), false);
                                w2ui['sidebar'].click('parameter');
                                setTimeout(function(){
                                    w2ui.layout.unlock('main');
                                }, 1500);
                            });
                            break;
                    }
                }
            }

        };
        // --- /Config for layout ---

        // --- Layout ---
        var pstyle = 'border: 1px solid #dfdfdf; padding: 2px;';
        $('#layout').w2layout({
            name: 'layout',
            panels: [
                { type: 'top', size:25, style: pstyle, content: "<center>Gonder</center>" },
                { type: 'left', size: 200, resizable: true, style: pstyle },
                { type: 'main', hidden: true, style: pstyle},
                { type: 'bottom', size: 250, resizable: true, style: pstyle }
            ]
        });
        w2ui.layout.content('left', $().w2sidebar(config.sidebar));
        w2ui.layout.content('main', $('#formbox').html());
        w2ui.layout.content('bottom', $('#bottom').html());
        // --- Parameters form ---
        $("#parameter").w2form({
            header: "Parameter",
            name: 'parameter',
            fields: [
                { name: 'campaignId', type: 'text', html: { caption: 'Id', attr: 'size="4" readonly' } },
                { name: 'campaignName', type: 'text', html: { caption: 'Name', attr: 'size="40" maxlength="40" readonly' } },
                { name: 'campaignProfileId', type: 'list', html: { caption: 'Profile', attr: 'size="40"' }, minLength: 0,
 //                   options: {items: profile},
                },
                { name: 'campaignSubject', type: 'text', html: { caption: 'Subject', attr: 'size="40" maxlength="40"' } },
                { name: 'campaignFromName', type: 'text', html: { caption: 'From name', attr: 'size="40"' } },
                { name: 'campaignFromEmail', type: 'email', html: { caption: 'From email', attr: 'size="40"' } },
                { name: 'campaignStartDate', type: 'date', html: { caption: 'Start date', attr: 'size="10"' } },
                { name: 'campaignStartTime', type: 'time', html: { caption: 'Start time', attr: 'size="10"' } },
                { name: 'campaignEndDate', type: 'date', html: { caption: 'End date', attr: 'size="10"' } },
                { name: 'campaignEndTime', type: 'time', html: { caption: 'End time', attr: 'size="10"' } },
                { name: 'campaignSendUnsubscribe', type: 'checkbox', html: { caption: 'Send unsubscribe' } },
            ]
        });
        // --- /Parameters form ---
        /*
        w2ui.parameter.on('*', function (event) {
            console.log('Event: '+ event.type, 'Target: '+ event.target, event);
            var item = $('#campaignProfileId').data('selected').id;
            console.log('ProfileId: ' + item);
        });
        */
        // --- /Layout ---




        // --- Group table ---
        $('#group').w2grid({
            name: 'group',
            header: 'Group',
            show: {
                header: true,
                toolbar: true,
                footer: true,
                toolbarAdd: true,
                toolbarDelete: false,
                toolbarSave: true,
            },
            columns: [
                { field: 'recid', caption: 'Id', size: '50px', style: 'background-color: #efefef; border-bottom: 1px solid white; padding-right: 5px;', attr: "align=right" },
                { field: 'name', caption: 'Name', size: '100%',  editable: { type: 'text' }},
            ],
            multiSelect: false,
            url: 'api/groups',
            method: 'GET',
            onSelect: function (event) {
                w2ui['campaign'].clear();
                var record = this.get(event.recid);
                w2ui['campaign'].load('api/campaigns?group='+event.recid);
            }
        });
        // --- /Group table ---

        // --- Campaign table ---
        $('#campaign').w2grid({
            header: 'Campaign',
            show: {
                header: true,
                toolbar: true,
                footer: true,
                toolbarAdd: true,
                toolbarDelete: true,
                toolbarSave: true,
            },
            name: 'campaign',
            columns: [
                { field: 'recid', caption: 'Id', size: '50px', style: 'background-color: #efefef; border-bottom: 1px solid white; padding-right: 5px;', attr: "align=right" },
                { field: 'name', caption: 'Name', size: '100%', editable: { type: 'text' } }
            ],
            multiSelect: false,
            url: 'api/campaigns',
            method: 'GET',
            onSelect: function (event) {
                w2ui.layout.lock('main', w2utils.lang('Loading...'), true);
                var record = this.get(event.recid);
                // --- Get campaign data ---
                $.ajax({
                    type: "GET",
                    url: 'api/campaign?cmd=get-data&recid='+event.recid,
                }).done(function(data) {
                    var profile;
                    $.ajax({
                        type: "GET",
                        async: false,
                        dataType: 'json',
                        url: 'api/profiles?cmd=get-list',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json"
                    }).done(function(data) {
                        profile = data;
                    });

                    w2ui['parameter'].set('campaignProfileId', { options: {
                        items: profile
                    }
                    });
                    w2ui['parameter'].record['campaignProfileId'] = data["profileId"];
                    w2ui['parameter'].refresh();

                    $('#campaignId').val(record.recid);
                    $('#campaignName').val(record.name);
                    $("#campaignSubject").val(data["subject"]);
                    $("#campaignFromName").val(data["fromName"]);
                    $("#campaignFromEmail").val(data["fromEmail"]);
                    $("#campaignStartDate").val(w2utils.formatDate((new Date(data["startDate"] * 1000)), w2utils.settings.dateFormat));
                    $("#campaignStartTime").val(w2utils.formatTime((new Date(data["startDate"] * 1000)), w2utils.settings.timeFormat));
                    $("#campaignEndDate").val(w2utils.formatDate((new Date(data["endDate"] * 1000)), w2utils.settings.dateFormat));
                    $("#campaignEndTime").val(w2utils.formatTime((new Date(data["endDate"] * 1000)), w2utils.settings.timeFormat));
                    $("#campaignSendUnsubscribe").prop("checked", data["sendUnsubscribe"] == "y" ? true : false);
                    $("#campaignTemplate").val(data["template"]);


                    CKEDITOR.instances.campaignTemplate.setData(data["template"]);
                }).complete(function() {
                    w2ui.layout.unlock('main');
                });
                // --- /Get campaign data ---
                w2ui['sidebar'].click('parameter');
            }
        });
        // --- /Campaign table ---




        // --- Recipients table ---
        $('#campaignRecipient').w2grid({
            header: "Recipients",
            name: 'recipient',
            show: {
                header: true,
                footer: true,
            },
            columns: [
                { field: 'name', caption: 'Name', size: '30%' },
                { field: 'email', caption: 'Email', size: '40%' },
            ],
            records: [
                { recid: 1, name: 'John', email: 'jdoe@gmail.com' },
                { recid: 2, name: 'Stuart', email: 'jdoe@gmail.com' },
                { recid: 3, name: 'Jin', email: 'jdoe@gmail.com' },
                { recid: 4, name: 'Susan', email: 'jdoe@gmail.com' },
                { recid: 5, name: 'Kelly', email: 'jdoe@gmail.com' },
                { recid: 6, name: 'Francis', email: 'jdoe@gmail.com' },
                { recid: 7, name: 'Mark', email: 'jdoe@gmail.com' },
                { recid: 8, name: 'Thomas', email: 'jdoe@gmail.com' }
            ],
            onExpand: function (event) {
                if (w2ui.hasOwnProperty('subgrid-' + event.recid)) w2ui['subgrid-' + event.recid].destroy();
                $('#'+ event.box_id).css({ margin: '0px', padding: '0px', width: '100%' }).animate({ height: '105px' }, 100);
                setTimeout(function () {
                    $('#'+ event.box_id).w2grid({
                        name: 'subgrid-' + event.recid,
                        fixedBody: true,
                        columns: [
                            { field: 'parametr', caption: 'Parametr', size: '30%' },
                            { field: 'value', caption: 'Value', size: '70%' },
                        ],
                        records: [
                            { recid: 1, parametr: 'FirstName', value: 'Bill'},
                            { recid: 2, parametr: 'LastName', value: 'Gatos'},
                            { recid: 3, parametr: 'Age', value: '65'},
                        ]
                    });
                    w2ui['subgrid-' + event.recid].resize();
                }, 300);
            }
        });
        // --- /Recipients table ---

        w2utils.lock('layout', 'Initializing...', true);
        setTimeout(function(){
            $('#template').hide();
            $('#recipient').hide();
            $('#parameter').hide();
        }, 1500);
        w2utils.unlock('layout');




        // --- CKEditor ---
        var editor = CKEDITOR.replace( 'campaignTemplate', {
                    filebrowserBrowseUrl: '/assets/filemanager/index.html?config=../../filemanager.config',
                    plugins:
                    //'dialogui,' +
                    'dialog,' +
                    'a11yhelp,' +
                    'dialogadvtab,' +
                    'basicstyles,' +
                    'bidi,' +
                    'blockquote,' +
                    'clipboard,' +
                    'button,' +
                    'panelbutton,' +
                    'panel,' +
                    'floatpanel,' +
                    'colorbutton,' +
                    'colordialog,' +
                    'templates,' +
                    'menu,' +
                    'contextmenu,' +
                    'div,' +
                    'resize,' +
                    'toolbar,' +
                    'elementspath,' +
                    'enterkey,' +
                    'entities,' +
                    'popup,' +
                    'filebrowser,' +
                    'find,' +
                    'fakeobjects,' +
                        //'flash,' +
                    'floatingspace,' +
                    'listblock,' +
                    'richcombo,' +
                    'font,' +
                        //'forms,' +
                    'format,' +
                    'horizontalrule,' +
                    'htmlwriter,' +
                        //'iframe,' +
                    'wysiwygarea,' +
                    'image,' +
                    'indent,' +
                    'indentblock,' +
                    'indentlist,' +
                        //'smiley,' +
                    'justify,' +
                    'menubutton,' +
                        //'language,' +
                    'link,' +
                    'list,' +
                    'liststyle,' +
                    'magicline,' +
                    'maximize,' +
                    'pagebreak,' +
                    'pastetext,' +
                    'pastefromword,' +
                    'preview,' +
                    'print,' +
                    'removeformat,' +
                    'selectall,' +
                    'showblocks,' +
                    'showborders,' +
                    'sourcearea,' +
                    'specialchar,' +
                    'scayt,' +
                    'stylescombo,' +
                    'tab,' +
                    'table,' +
                    'tabletools,' +
                    'undo,' +
                    'wsc,' +
                    'docprops,',

                    allowedContent:  true,
                    removeFormatAttributes: '',
                    height: 400,
                }
        );

/*
        editor.on( 'instanceReady', function() {
            console.log( editor.filter.allowedContent );
        } );
*/
        // --- /CKEditor ---

    });
    </script>

</body>
</html>