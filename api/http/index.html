<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Gonder panel</title>
    <link rel="stylesheet" type="text/css" href="assets/w3ui/w2ui-1.4.3.min.css" />
    <script src="assets/jquery/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="assets/w3ui/w2ui-1.4.3.js"></script>
    <script src="assets/ckeditor/ckeditor.js"></script>
</head>
<body>

    <div id="layout" style="position: absolute; width: 99%; height: 99%;"></div>

    <div id="bottom" style="visibility: hidden">
        <div id="group" style="position: absolute; left: 0; width: 39.9%; height: 99%;"></div>
        <div id="campaign" style="position: absolute; right: 0; width: 59.9%; height: 99%;"></div>
    </div>

    <div id="formbox" style="visibility: hidden">
        <div id="parameter"></div>
        <div id="template">
            <textarea id="campaignTemplate" name="campaignTemplate"></textarea>
            <strong>System variables:</strong> {{.CampaignId}} {{.RecipientEmail}} {{.RecipientName}} {{.StatPng}} {{.UnsubscribeUrl}} {{.WebUrl}}
        </div>
        <div id="recipient" style="width: 100%;">
            <div id="campaignRecipient" style="height: 400px;"></div>
            <div id="recipientUpload">
                <div class="w2ui-field w2ui-span3">
                    <label></label>
                    <div>
                        <input id="recipientUploadFile" style="width: 600px;"><button id="recipientUploadButton" class="btn"></button><button id="recipientDeleteAllButton" class="btn"></button>
                        <button id="recipientResend" class="btn"></button>
                    </div>
                </div>
            </div>
        </div>
        <div id="profile" style="height: 100%"></div>
        <div id="status" style="height: 100%">
            <div>
                <input id="statusLogCampaign" type="radio" name="statusLogName" value="campaign" onclick="startStatusLog('campaign.log');"> Campaign
                <input id="statusLogUtm" type="radio" name="statusLogName" value="statistic" onclick="startStatusLog('utm.log');"> Utm
                <input id="statusLogApi" type="radio" name="statusLogName" value="api" onclick="startStatusLog('api.log');"> API
                <input id="statusLogMain"type="radio" name="statusLogName" value="main" onclick="startStatusLog('main.log');"> Main
            </div>
            <div id="statusLog" style="overflow-y: auto; height:95%; border:1px solid rgb(223, 223, 223); background: #fff; padding: 5px; font-size: 12px;">Select log</div>
        </div>
    </div>


    <script type="text/javascript">

        var ws = null;

        function startStatusLog(file){
            var statusLog = $("#statusLog");
            var wsuri = window.location.protocol=="https:"?"wss://":"ws://";
            wsuri += window.location.hostname;
            wsuri += window.location.port==""?"":":"+window.location.port;
            wsuri += "/status/ws/" + file;

            if (ws == null) {
                ws = new WebSocket(wsuri);
            } else {
                ws.close();
                setTimeout(function(){}, 2000);
                ws = new WebSocket(wsuri);
            }

            statusLog.empty();

            ws.onopen = function() {
                console.log("connected to " + wsuri);
            };

            ws.onclose = function(e) {
                console.log("connection to " + wsuri + " closed (" + e.code + ") clean = " + e.wasClean);
            };

            ws.onmessage = function(e) {
                statusLog.append(e.data + "<br/>");
                statusLog.scrollTop(statusLog.prop("scrollHeight"));
            };
/*
            setInterval(function() {
                ws.send("ping");
            }, 1000)
*/
        }

        $(function () {

            w2utils.locale('/assets/locale/ru-ru.json');

            function getDate(dateStr, timeStr) {
                //ToDo parse config format
                //w2utils.settings.dateFormat
                var dateParts = dateStr.split("/");
                var timeParts = timeStr.split(":");
                return new Date(dateParts[2],(dateParts[1] - 1),dateParts[0],timeParts[0],timeParts[1],0);
            }

            function refreshProfilesList(selectedProfile){
                var profile;
                $.ajax({
                    type: "GET",
                    async: false,
                    url: '/api/profilelist',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                }).done(function(data) {
                    profile = data;
                });
                w2ui['parameter'].set('campaignProfileId', { options: { items: profile } });
                w2ui['parameter'].record['campaignProfileId'] = selectedProfile;
                w2ui['parameter'].refresh();
            }

            function refreshSenderList(selectedSender){
                var sender;
                $.ajax({
                    type: "GET",
                    async: false,
                    url: '/api/senderlist?groupId=' + w2ui['group'].getSelection()[0],
                    contentType: "application/json; charset=utf-8",
                    dataType: "json"
                }).done(function(data) {
                    sender = data;
                });
                console.log(sender);
                w2ui['parameter'].set('campaignSenderId', { options: { items: sender } });
                w2ui['parameter'].record['campaignSenderId'] = selectedSender;
                w2ui['parameter'].refresh();
            }

            // --- Config for layout ---
            var config = {
                sidebar: {
                    name: 'sidebar',
                    topHTML: '<div style="padding: 10px 5px; border-bottom: 1px solid #99bbe8";><span style="text-transform: uppercase;">'+w2utils.lang("Menu")+'</span></div>',
                    nodes: [
                        {
                            id: 'campaign', text: w2utils.lang('Campaign'), group: true, expanded: true, nodes:
                                [
                                    {id: 'parameter', text: w2utils.lang('Parameters'), img: 'icon-page'},
                                    {id: 'editor', text: w2utils.lang('Editor'), img: 'w2ui-icon-pencil'},
                                    {id: 'recipient', text: w2utils.lang('Recipients'), img: 'w2ui-icon-columns'},
                                    {id: 'save', text: w2utils.lang('Save'), img: 'w2ui-icon-check'}
                                ]
                        },
                        {
                            id: 'settings', text: w2utils.lang('Settings'), group: true, expanded: false, nodes:
                                [
                                    {id: 'profile', text: w2utils.lang('Profiles'), img: 'icon-page'},
                                    {id: 'status', text: w2utils.lang('Status'), img: 'w2ui-icon-columns'}
                                ]
                        }
                    ],
                    onClick: function (event) {
                        if ($('#campaignId').val() != '' || event.target =='profile'  || event.target =='status') {
                            switch (event.target) {
                                case 'parameter':
                                    $('#template').hide();
                                    $('#recipient').hide();
                                    $('#parameter').show();
                                    $('#profile').hide();
                                    $('#status').hide();
                                    break;
                                case 'editor':
                                    $('#parameter').hide();
                                    $('#recipient').hide();
                                    $('#template').show();
                                    $('#profile').hide();
                                    $('#status').hide();
                                    break;
                                case 'recipient':
                                    w2ui['recipient'].url = '/api/recipients?content=recipients&campaign=' + $('#campaignId').val();
                                    w2ui['recipient'].reload();
                                    $('#template').hide();
                                    $('#parameter').hide();
                                    $('#recipient').show();
                                    $('#profile').hide();
                                    $('#status').hide();
                                    break;
                                case 'save':
                                    w2confirm(w2utils.lang('Save changes in campaign?'), function (btn) {
                                        if ( btn == 'Yes') {
                                            // ---Save campaign data ---
                                            w2ui.layout.lock('main', w2utils.lang('Saving...'), true);
                                            data = {
                                                "recid": $('#campaignId').val(),
                                                "profileId": $('#campaignProfileId').data('selected').id,
                                                "name": $('#campaignName').val(),
                                                "subject": $("#campaignSubject").val(),
                                                "senderId": $('#campaignSenderId').data('selected').id,
                                                "startDate": getDate($("#campaignStartDate").val(), $("#campaignStartTime").val()).getTime()/1000,
                                                "endDate": getDate($("#campaignEndDate").val(), $("#campaignEndTime").val()).getTime()/1000,
                                                "sendUnsubscribe": $("#campaignSendUnsubscribe").is(":checked"),
                                                "template": CKEDITOR.instances.campaignTemplate.getData() == ''?$("#campaignTemplate").val():CKEDITOR.instances.campaignTemplate.getData(),
                                            };
                                            $.ajax({
                                                type: "POST",
                                                url: '/api/campaign?cmd=save-data',
                                                data: JSON.stringify(data),
                                                contentType: "application/json; charset=utf-8",
                                                dataType: "json"
                                            }).done(function(data) {
                                                if (data['status'] == 'error') {
                                                    w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                                }
                                            }).complete(function() {
                                                w2ui.layout.lock('main', w2utils.lang('Saved'), false);
                                                w2ui['sidebar'].click('parameter');
                                                setTimeout(function(){
                                                    w2ui.layout.unlock('main');
                                                }, 1500);
                                            });
                                        }
                                    });
                                    // ToDo this
                                    w2ui['sidebar'].select(w2ui['sidebar'].selected);
                                    w2ui['sidebar'].unselect('save');
                                    break;

                                case 'profile':
                                    w2ui['profile'].url = '/api/profiles';
                                    w2ui['profile'].reload();
                                    $('#template').hide();
                                    $('#parameter').hide();
                                    $('#recipient').hide();
                                    $('#profile').show();
                                    $('#status').hide();
                                    break;
                                case 'status':
                                    $('#template').hide();
                                    $('#parameter').hide();
                                    $('#recipient').hide();
                                    $('#profile').hide();
                                    $('#status').show();
                                    break;
                            }
                            w2ui['layout'].resize();
                        } else {
                            w2ui['sidebar'].unselect(event.target);
                            w2alert(w2utils.lang('Select group and campaign, before select action.'));
                        }
                    }
                }
            };
            // --- /Config for layout ---

            // --- Layout ---
            var pstyle = 'border: 1px solid #dfdfdf; padding: 2px;';
            $('#layout').w2layout({
                name: 'layout',
                panels: [
                    { type: 'top', size:32, style: pstyle, content: "<div style='text-align: center;'><img src='/assets/img/logo.png' height='20px' border='0px'/><span style='font-size: 20px;'> Mass email sender</span></div>" },
                    { type: 'left', size: 200, resizable: true, style: pstyle },
                    { type: 'main', hidden: true, style: pstyle},
                    { type: 'bottom', size: 250, resizable: true, style: pstyle }
                ]
            });
            w2ui.layout.content('left', $().w2sidebar(config.sidebar));
            w2ui.layout.content('main', $('#formbox').html());
            w2ui.layout.content('bottom', $('#bottom').html());

            // --- Parameters form ---
            $('#parameter').w2form({
                header: w2utils.lang("Parameters"),
                name: 'parameter',
                fields: [
                    { name: 'campaignId', type: 'text', html: { caption: w2utils.lang('Id'), attr: 'size="4" readonly' } },
                    { name: 'campaignName', type: 'text', html: { caption: w2utils.lang('Name'), attr: 'size="40" readonly' } },
                    { name: 'campaignProfileId', type: 'list', html: { caption: w2utils.lang('Profile'), attr: 'size="40"' }, minLength: 0},
                    { name: 'campaignSubject', type: 'text', html: { caption: w2utils.lang('Subject'), attr: 'size="40"' } },
                    { name: 'campaignSenderId', type: 'list', html: { caption: w2utils.lang('Sender'), attr: 'size="40"' }, minLength: 0},
                    { name: 'campaignStartDate', type: 'date', html: { caption: w2utils.lang('Start date'), attr: 'size="10"' } },
                    { name: 'campaignStartTime', type: 'time', html: { caption: w2utils.lang('Start time'), attr: 'size="10"' } },
                    { name: 'campaignEndDate', type: 'date', html: { caption: w2utils.lang('End date'), attr: 'size="10"' } },
                    { name: 'campaignEndTime', type: 'time', html: { caption: w2utils.lang('End time'), attr: 'size="10"' } },
                    { name: 'campaignSendUnsubscribe', type: 'checkbox', html: { caption: w2utils.lang('Send unsubscribe') } },
                    { name: 'campaignAcceptSend', type: 'toggle', html: { caption: w2utils.lang('Accept send') } }
                ]
            });

            $('#campaignSendUnsubscribe').click(function(data) {
                if ($('#campaignSendUnsubscribe').is(':checked')) {
                    w2confirm(w2utils.lang('You are sure send mail for unsubscribed?'), function (btn) {
                        if (btn != 'Yes') {
                            $('#campaignSendUnsubscribe').prop('checked', !$('#campaignSendUnsubscribe').is(':checked'));
                        }
                    });
                }
            });

            $('#campaignAcceptSend').click(function(data) {
                var confirm;
                if ($('#campaignAcceptSend').is(':checked')) {
                    confirm = 'You are sure to activate campaign?';
                } else {
                    confirm = 'You are sure to deactivate campaign?';
                }
                w2confirm(w2utils.lang(confirm), function (btn) {
                    if (btn == 'Yes') {
                        $.ajax({
                            type: "POST",
                            url: '/api/campaign?cmd=accept',
                            data: JSON.stringify({
                                recid: $('#campaignId').val(),
                                accepted: $('#campaignAcceptSend').is(':checked')
                            }),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        }).done(function (data) {
                            if (data['status'] == 'error') {
                                w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                $('#campaignAcceptSend').prop('checked', !$('#campaignAcceptSend').is(':checked'));
                            }
                        })
                    } else {
                        $('#campaignAcceptSend').prop('checked', !$('#campaignAcceptSend').is(':checked'));

                    }
                });
            });

            // --- /Parameters form ---

            $('#template').hide();
            $('#recipient').hide();
            $('#parameter').hide();
            $('#profile').hide();
            $('#status').hide();

            // --- /Layout ---

            // --- Sender emails editor ---
            $().w2layout({
                name: 'senderEditor',
                padding: 4,
                panels: [
                    { type: 'left', size: '40%', resizable: true, minSize: 300 },
                    { type: 'main', minSize: 300 }
                ]
            });
            $().w2grid({
                name: 'senderGrid',
                columns: [
                    { field: 'email', caption: w2utils.lang('Email'), size: '50%' },
                    { field: 'name', caption: w2utils.lang('Name'), size: '50%'}
                ],
                method: 'GET',
                onClick: function(event) {
                    var grid = this;
                    var form = w2ui.senderForm;
                    event.onComplete = function () {
                        var sel = grid.getSelection();
                        if (sel.length == 1) {
                            form.recid  = sel[0];
                            form.record = $.extend(true, {}, grid.get(sel[0]));
                            form.refresh();
                        } else {
                            form.clear();
                        }
                    }
                }
            });
            $().w2form({
                header: w2utils.lang('Edit Record'),
                name: 'senderForm',
                fields: [
                    { name: 'recid', type: 'text', html: { caption: 'ID', attr: 'size="10" readonly' } },
                    { name: 'name', type: 'text', html: { caption: w2utils.lang('Name'), attr: 'size="40" maxlength="40"' } },
                    { name: 'email', type: 'email', required: true, html: { caption: w2utils.lang('Email'), attr: 'size="30"' } }
                ],
                actions: {
                    Reset: function () {
                        this.clear();
                    },
                    Save: function () {
                        var errors = this.validate();
                        if (errors.length > 0) return;
                        var url;
                        var i = this;
                        if (i.recid == 0) {
                            url = '/api/sender?cmd=add-record&groupId=' + w2ui['group'].getSelection()[0];
                        } else {
                            url = '/api/sender?cmd=save-record';
                        }
                        $.ajax({
                            type: "GET",
                            url: url,
                            data: i.record,
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        }).done(function (data) {

                            if (data['status'] == 'error') {
                                w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                            } else {
                                if (i.recid == 0) {
                                    i.record.recid = data["recid"];
                                    w2ui.senderGrid.add($.extend(true, { recid: data["recid"] }, i.record));
                                } else {
                                    w2ui.senderGrid.set(i.recid, i.record);
                                }
                                w2ui.senderGrid.selectNone();
                                i.clear();
                                refreshSenderList($('#campaignSenderId').data('selected').id);
                            }
                        });

                    }
                }
            });
            // --- /Sender emails editor ---

            // --- Group table ---
            $('#group').w2grid({
                name: 'group',
                header: w2utils.lang('Group'),
                show: {
                    header: true,
                    toolbar: true,
                    footer: true,
                    toolbarSave: true,
                    toolbarSearch: false
                },
                columns: [
                    { field: 'recid', caption: w2utils.lang('Id'), size: '50px', style: 'background-color: #efefef; border-bottom: 1px solid white; padding-right: 5px;', attr: "align=right" },
                    { field: 'name', caption: w2utils.lang('Name'), size: '100%',  editable: { type: 'text' }}
                ],
                multiSelect: false,
                sortData: [{ field: 'recid', direction: 'DESC' }],
                url: '/api/groups',
                method: 'GET',
                onSelect: function (event) {
                    w2ui['campaign'].url = '/api/campaigns?group=' + event.recid;
                    w2ui['campaign'].reload();

                },
                toolbar: {
                    items: [
                        {id: 'add', type: 'button', caption: w2utils.lang('Add New'), icon: 'w2ui-icon-plus'},
                        {id: 'sender', type: 'button', caption: w2utils.lang('Emails'), icon: 'w2ui-icon-pencil'}
                    ],
                    onClick: function (event) {
                        if (event.target == 'add') {
                            var id, name
                            $.ajax({
                                type: "POST",
                                dataType: 'json',
                                url: '/api/groups?cmd=add-record'
                            }).done(function(data) {
                                if (data['status'] == 'error') {
                                    w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                } else {
                                    id = data["recid"];
                                    name = data["name"];
                                    w2ui.group.add({recid: id, name: name});
                                    w2ui.group.editField(id, 1);
                                }
                            });
                        }


                        if (event.target == 'sender') {
                            if (w2ui['group'].getSelection()[0] == undefined) {
                                w2alert(w2utils.lang('Select group.'));
                            } else {
                                w2ui['senderGrid'].url = '/api/sender?' + 'groupId=' + w2ui['group'].getSelection()[0];
                                w2popup.open({
                                    title   : w2utils.lang('Email list editor'),
                                    width   : 900,
                                    height  : 600,
                                    showMax : true,
                                    body    : '<div id="senderPopup" style="position: absolute; left: 5px; top: 5px; right: 5px; bottom: 5px;"></div>',
                                    onOpen  : function (event) {
                                        event.onComplete = function () {
                                            $('#w2ui-popup #senderPopup').w2render('senderEditor');
                                            w2ui.senderEditor.content('left', w2ui['senderGrid']);
                                            w2ui.senderEditor.content('main', w2ui['senderForm']);
                                        };
                                    },
                                    onToggle: function (event) {
                                        event.onComplete = function () {
                                            w2ui.senderEditor.resize();
                                        }
                                    }
                                });
                            }
                        }
                    }
                }
            });
            // --- /Group table ---

            // --- Campaign table ---
            $('#campaign').w2grid({
                header: w2utils.lang('Campaign'),
                show: {
                    header: true,
                    toolbar: true,
                    footer: true,
                    toolbarDelete: false,
                    toolbarSave: true,
                    toolbarSearch: false
                },
                name: 'campaign',
                columns: [
                    { field: 'recid', caption: w2utils.lang('Id'), size: '50px', style: 'background-color: #efefef; border-bottom: 1px solid white; padding-right: 5px;', attr: "align=right" },
                    { field: 'name', caption: w2utils.lang('Name'), size: '100%', editable: { type: 'text' } }
                ],
                multiSelect: false,
                sortData: [{ field: 'recid', direction: 'DESC' }],
                method: 'GET',
                toolbar: {
                    items: [
                        {id: 'add', type: 'button', caption: w2utils.lang('Add New'), icon: 'w2ui-icon-plus'}
                    ],
                    onClick: function (event) {
                        if (event.target == 'add') {
                            var id, name;
                            $.ajax({
                                type: "POST",
                                //async: false,
                                dataType: 'json',
                                url: '/api/campaigns?cmd=add-record&group=' + w2ui['group'].getSelection()
                            }).done(function(data) {
                                if (data['status'] == 'error') {
                                    w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                } else {
                                    id = data["recid"];
                                    name = data["name"];
                                    w2ui.campaign.add({recid: id, name: name});
                                    w2ui.campaign.editField(id, 1);
                                }
                            });

                        }
                    }
                },
                onSelect: function (event) {
                    w2ui.layout.lock('main', w2utils.lang('Loading...'), true);
                    var record = this.get(event.recid);
                    // --- Get campaign data ---
                    $.ajax({
                        type: "GET",
                        url: '/api/campaign?cmd=get-data&recid=' + event.recid
                    }).done(function(data) {
                        zone = new Date().getTimezoneOffset() * 60;
                        refreshProfilesList(data["profileId"]);
                        refreshSenderList(data["senderId"]);
                        $('#campaignId').val(record.recid);
                        $('#campaignName').val(record.name);
                        $("#campaignSubject").val(data["subject"]);
                        $("#campaignStartDate").val(w2utils.formatDate((new Date((data["startDate"] + zone)* 1000 )), w2utils.settings.dateFormat));
                        $("#campaignStartTime").val(w2utils.formatTime((new Date((data["startDate"] + zone) * 1000)), w2utils.settings.timeFormat));
                        $("#campaignEndDate").val(w2utils.formatDate((new Date((data["endDate"] + zone) * 1000)), w2utils.settings.dateFormat));
                        $("#campaignEndTime").val(w2utils.formatTime((new Date((data["endDate"] + zone) * 1000)), w2utils.settings.timeFormat));
                        $("#campaignSendUnsubscribe").prop("checked", data["sendUnsubscribe"]);
                        $("#campaignTemplate").val(data["template"]);
                        $('#campaignAcceptSend').prop('checked', data["accepted"]);

                        CKEDITOR.instances.campaignTemplate.setData(data["template"]);
                    }).complete(function() {
                        w2ui.layout.unlock('main');
                        w2ui['sidebar'].click('parameter');
                    });
                    // --- /Get campaign data ---

                },
                onSave: function(event) {
                    console.log(event);
                }
            });
            // --- /Campaign table ---

            // --- Recipients table ---
            $('#campaignRecipient').w2grid({
                header: w2utils.lang("Recipients"),
                name: 'recipient',
                show: {
                    header: true,
                    footer: true
                },
                columns: [
                    { field: 'recid', caption: w2utils.lang('Id'), size: '5%' },
                    { field: 'email', caption: w2utils.lang('Email'), size: '15%' },
                    { field: 'name', caption: w2utils.lang('Name'), size: '20%' },
                    { field: 'result', caption: w2utils.lang('Result'), size: '60%' }
                ],
                multiSelect: false,
                method: 'GET',
                onExpand: function (event) {
                    if (w2ui.hasOwnProperty('subgrid-' + event.recid)) w2ui['subgrid-' + event.recid].destroy();
                    $('#'+ event.box_id).css({ margin: '0px', padding: '0px', width: '100%' }).animate({ height: '100px' }, 100);
                    setTimeout(function () {
                        $('#'+ event.box_id).w2grid({
                            name: 'subgrid-' + event.recid,
                            fixedBody: true,
                            columns: [
                                { field: 'key', caption: w2utils.lang('Parameter'), size: '30%' },
                                { field: 'value', caption: w2utils.lang('Value'), size: '70%' },
                            ],
                            multiSelect: false,
                            url: '/api/recipients?content=parameters&recipient='+event.recid,
                            method: 'GET'
                        });
                        w2ui['subgrid-' + event.recid].resize();
                    }, 300);
                },
                onDblClick: function (event) {
                    /*w2popup.load({
                        title: 'Mail preview',
                        url: '/preview?id='+event.recid,
                        showMax: true
                    });*/
                    preview = window.open(
                            "/preview?id="+event.recid,
                            "Preview mail"+event.recid,
                            "width=800,height=600,resizable=yes,scrollbars=yes,status=yes"
                    );
                    preview.focus();
                }
            });
            // --- /Recipients table ---

            // --- Recipient upload ---
            $('#recipientUploadFile').w2field('file', {accept:'.csv', silent: false/*placeholder: 'Select file'*/});
            $("#recipientUploadButton").html(w2utils.lang('Upload'));
            $('#recipientUploadButton').click(
                    function () {
                        if ($('#recipientUploadFile').data("selected").length == 0) {
                            w2alert(w2utils.lang('No one file selected.'), w2utils.lang('Error'));
                        } else {
                            w2ui.layout.lock('main', w2utils.lang('Uploading...'), true);
                            $.each($('#recipientUploadFile').data('selected'), function(index, file){
                                $.ajax({
                                    url: "api/recipients",
                                    type: "POST",
                                    data: {
                                        content: "recipients",
                                        cmd: "upload",
                                        campaign: $('#campaignId').val(),
                                        name: file.name,
                                        base64: file.content
                                    },
                                    dataType: "json"
                                }).done(function(data) {
                                    if (data['status'] == 'error') {
                                        w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                    }
                                }).complete(function() {
                                    $('#recipientUploadFile').w2field('file', {accept:'.csv', silent: false});
                                    w2ui['recipient'].reload();
                                    w2ui.layout.unlock('main');
                                });
                            });
                        }
                    }
            );
            // --- /Recipient upload ---

            // --- Recipient delete all ---
            $("#recipientDeleteAllButton").html(w2utils.lang('Delete all'));
            $("#recipientDeleteAllButton").click(
                    function () {
                        w2confirm(w2utils.lang('Delete all recipients from campaign?'), function (btn) {
                            if (btn == 'Yes') {
                                w2ui.layout.lock('main', w2utils.lang('Deleting...'), true);
                                $.ajax({
                                    url: "api/recipients",
                                    type: "POST",
                                    data: {
                                        content: "recipients",
                                        cmd: "deleteAll",
                                        campaign: $('#campaignId').val(),
                                    },
                                    dataType: "json"
                                }).done(function(data) {
                                    if (data['status'] == 'error') {
                                        w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                    }
                                }).complete(function() {
                                    w2ui['recipient'].reload();
                                    w2ui.layout.unlock('main');
                                })
                            }
                        })
                    }
            );
            // --- /Recipient delete all ---

            // --- Recipient resend ---
            $("#recipientResend").html(w2utils.lang('Resend by 4x1 code'));
            $('#recipientResend').click(
                    function () {
                        console.log("click resend");
                        w2confirm(w2utils.lang('Resend by 421 and 451 code?'), function (btn) {
                            if (btn == 'Yes') {
                                w2ui.layout.lock('main', w2utils.lang('Deleting...'), true);
                                $.ajax({
                                    url: "api/recipients",
                                    type: "POST",
                                    data: {
                                        content: "recipients",
                                        cmd: "resend4x1",
                                        campaign: $('#campaignId').val(),
                                    },
                                    dataType: "json"
                                }).done(function(data) {
                                    if (data['status'] == 'error') {
                                        w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                                    }
                                }).complete(function() {
                                    w2ui['recipient'].reload();
                                    w2ui.layout.unlock('main');
                                })
                            }
                        })

                    }
            );
            // --- Recipient resend ---

            // --- Profile table ---
            $('#profile').w2grid({
                name: 'profile',
                header: w2utils.lang('Profiles'),
                show: {
                    header: true,
                    toolbar: true,
                    footer: true,
                    toolbarSave: true,
                    toolbarDelete: true,
                    toolbarAdd: true,
                    toolbarSearch: false
                },
                columns: [
                    { field: 'recid', caption: w2utils.lang('Id'), size: '50px', style: 'background-color: #efefef; border-bottom: 1px solid white; padding-right: 5px;', attr: "align=right" },
                    { field: 'name', caption: w2utils.lang('Name'), size: '30%', editable: { type: 'text' }},
                    { field: 'host', caption: w2utils.lang('Host'), size: '20%', editable: { type: 'text' }},
                    { field: 'iface', caption: w2utils.lang('Interface'), size: '20%',  editable: { type: 'text' }},
                    { field: 'stream', caption: w2utils.lang('Stream'), render: 'int', size: '10%', editable: { type: 'int' }},
                    { field: 'resend_delay', caption: w2utils.lang('Resend delay'), render: 'int', size: '10%', editable: { type: 'int' }},
                    { field: 'resend_count', caption: w2utils.lang('Resend count'), render: 'int', size: '10%', editable: { type: 'int' }}

                ],
                method: 'GET',
                onAdd: function(event) {
                    console.log(event);
                    $.ajax({
                        url: "api/profiles",
                        type: "GET",
                        data: {
                            cmd: "add-records",
                        },
                        dataType: "json"
                    }).done(function(data) {
                        if (data['status'] == 'error') {
                            w2alert(w2utils.lang(data["message"]), w2utils.lang('Error'));
                        } else {
                            console.log(data);
                            w2ui.profile.add({ recid: data.recid });
                        }
                    }).complete(function(data) {

                    });
                }
            });
            // --- /Profile table ---

            // --- CKEditor ---
            var editor = CKEDITOR.replace(
                    'campaignTemplate', {
                        filebrowserBrowseUrl: '/assets/filemanager/index.html?config=../../filemanager.config',
                        plugins:
                        //'dialogui,' +
                        'dialog,' +
                        'a11yhelp,' +
                        'dialogadvtab,' +
                        'basicstyles,' +
                        'bidi,' +
                        'blockquote,' +
                        'clipboard,' +
                        'button,' +
                        'panelbutton,' +
                        'panel,' +
                        'floatpanel,' +
                        'colorbutton,' +
                        'colordialog,' +
                        'templates,' +
                        'menu,' +
                        'contextmenu,' +
                        'div,' +
                        'resize,' +
                        'toolbar,' +
                        'elementspath,' +
                        'enterkey,' +
                        'entities,' +
                        'popup,' +
                        'filebrowser,' +
                        'find,' +
                        'fakeobjects,' +
                            //'flash,' +
                        'floatingspace,' +
                        'listblock,' +
                        'richcombo,' +
                        'font,' +
                            //'forms,' +
                        'format,' +
                        'horizontalrule,' +
                        'htmlwriter,' +
                            //'iframe,' +
                        'wysiwygarea,' +
                        'image,' +
                        'indent,' +
                        'indentblock,' +
                        'indentlist,' +
                            //'smiley,' +
                        'justify,' +
                        'menubutton,' +
                            //'language,' +
                        'link,' +
                        'list,' +
                        'liststyle,' +
                        'magicline,' +
                        'maximize,' +
                        'pagebreak,' +
                        'pastetext,' +
                        'pastefromword,' +
                        'preview,' +
                        'print,' +
                        'removeformat,' +
                        'selectall,' +
                        'showblocks,' +
                        'showborders,' +
                        'sourcearea,' +
                        'specialchar,' +
                        'scayt,' +
                        'stylescombo,' +
                        'tab,' +
                        'table,' +
                        'tabletools,' +
                        'undo,' +
                        'wsc,' +
                        'docprops,',

                        allowedContent:  true,
                        removeFormatAttributes: '',
                        height: 400,
                        entities:false
                    }
            );

            /*
             editor.on( 'instanceReady', function() {
             console.log( editor.filter.allowedContent );
             } );
             */
            // --- /CKEditor ---
        });

    </script>

</body>
</html>